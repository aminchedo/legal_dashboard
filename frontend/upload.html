<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>آپلود فایل | سامانه هوشمند</title>
    
    <!-- Preconnect for better performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    
    <!-- فونت و آیکون‌ها -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>
<body>
    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <a href="index.html" class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-gavel"></i>
                    </div>
                    <span class="logo-text">داشبورد حقوقی</span>
                </a>
                <button class="mobile-menu-toggle" id="mobile-menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>

            <!-- Navigation -->
            <nav class="main-nav">
                <div class="nav-section">
                    <h4 class="nav-title">اصلی</h4>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="index.html" class="nav-link" data-nav="dashboard">
                                <span class="nav-icon"><i class="fas fa-tachometer-alt"></i></span>
                                <span>داشبورد</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="documents.html" class="nav-link" data-nav="documents">
                                <span class="nav-icon"><i class="fas fa-file-alt"></i></span>
                                <span>مدیریت اسناد</span>
                                <span class="nav-badge" data-badge="documents">0</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="upload.html" class="nav-link active" data-nav="upload">
                                <span class="nav-icon"><i class="fas fa-cloud-upload-alt"></i></span>
                                <span>آپلود فایل</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="search.html" class="nav-link" data-nav="search">
                                <span class="nav-icon"><i class="fas fa-search"></i></span>
                                <span>جستجو</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="analytics.html" class="nav-link" data-nav="analytics">
                                <span class="nav-icon"><i class="fas fa-chart-bar"></i></span>
                                <span>تحلیل و گزارش</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="recent-activity.html" class="nav-link" data-nav="recentActivity">
                                <span class="nav-icon"><i class="fas fa-history"></i></span>
                                <span>فعالیت‌های اخیر</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="nav-section">
                    <h4 class="nav-title">سیستم</h4>
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="system-health.html" class="nav-link" data-nav="systemHealth">
                                <span class="nav-icon"><i class="fas fa-heartbeat"></i></span>
                                <span>وضعیت سیستم</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="settings.html" class="nav-link" data-nav="settings">
                                <span class="nav-icon"><i class="fas fa-cog"></i></span>
                                <span>تنظیمات</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="scraping.html" class="nav-link" data-nav="scraping">
                                <span class="nav-icon"><i class="fas fa-spider"></i></span>
                                <span>استخراج محتوا</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="reports.html" class="nav-link" data-nav="reports">
                                <span class="nav-icon"><i class="fas fa-file-alt"></i></span>
                                <span>گزارش‌ها</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <h1 class="header-title">آپلود فایل</h1>
                <div class="header-actions">
                    <button class="btn-icon" id="user-menu-btn">
                        <i class="fas fa-user-circle"></i>
                    </button>
                    <button class="btn-icon" id="notification-bell">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notification-badge">0</span>
                    </button>
                </div>
            </header>

            <!-- Breadcrumbs -->
            <div class="breadcrumb-container" id="breadcrumb-container">
                <a href="index.html" class="breadcrumb-item">
                    <i class="fas fa-home"></i>
                    <span>خانه</span>
                </a>
                <i class="fas fa-angle-left mx-2 text-gray-400"></i>
                <span class="breadcrumb-item active" aria-current="page">آپلود فایل</span>
            </div>

            <!-- Upload Section -->
            <section class="upload-section">
                <!-- Upload Zones -->
                <div class="upload-zones">
                    <div class="upload-zone" id="pdf-upload-zone">
                        <div class="upload-icon">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <h3>آپلود فایل PDF</h3>
                        <p>فایل PDF خود را برای استخراج متن بکشید و رها کنید یا انتخاب کنید</p>
                        <button class="btn btn-primary" id="pdf-upload-btn">
                            <i class="fas fa-file-pdf"></i>
                            انتخاب فایل PDF
                        </button>
                        <input type="file" id="pdf-file-input" accept=".pdf" style="display: none;">
                    </div>

                    <div class="upload-zone" id="image-upload-zone">
                        <div class="upload-icon">
                            <i class="fas fa-image"></i>
                        </div>
                        <h3>آپلود تصویر</h3>
                        <p>تصویر سند را برای OCR بکشید و رها کنید یا انتخاب کنید</p>
                        <button class="btn btn-primary" id="image-upload-btn">
                            <i class="fas fa-image"></i>
                            انتخاب تصویر
                        </button>
                        <input type="file" id="image-file-input" accept=".jpg,.jpeg,.png,.bmp,.tiff" style="display: none;">
                    </div>

                    <div class="upload-zone" id="document-upload-zone">
                        <div class="upload-icon">
                            <i class="fas fa-file-word"></i>
                        </div>
                        <h3>آپلود سند Word</h3>
                        <p>فایل Word خود را برای پردازش بکشید و رها کنید یا انتخاب کنید</p>
                        <button class="btn btn-primary" id="document-upload-btn">
                            <i class="fas fa-file-word"></i>
                            انتخاب فایل Word
                        </button>
                        <input type="file" id="document-file-input" accept=".doc,.docx" style="display: none;">
                    </div>
                </div>

                <!-- Upload Queue -->
                <div class="upload-queue" id="upload-queue" style="display: none;">
                    <div class="queue-header">
                        <h3>صف آپلود</h3>
                        <button class="btn btn-secondary" id="clear-queue-btn">
                            <i class="fas fa-trash"></i>
                            پاک کردن صف
                        </button>
                    </div>
                    <div class="queue-items" id="queue-items">
                        <!-- Queue items will be added here dynamically -->
                    </div>
                </div>

                <!-- Upload Progress -->
                <div class="upload-progress" id="upload-progress" style="display: none;">
                    <div class="progress-header">
                        <h3>در حال آپلود</h3>
                        <span class="progress-text" id="progress-text">0%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                </div>
            </section>

            <!-- Results Section -->
            <section class="results-section" id="results-section" style="display: none;">
                <div class="results-header">
                    <h3>نتایج پردازش</h3>
                    <div class="results-actions">
                        <button class="btn btn-secondary" id="copy-result-btn">
                            <i class="fas fa-copy"></i>
                            کپی متن
                        </button>
                        <button class="btn btn-primary" id="download-result-btn">
                            <i class="fas fa-download"></i>
                            دانلود نتیجه
                        </button>
                        <button class="btn btn-danger" id="clear-result-btn">
                            <i class="fas fa-trash"></i>
                            پاک کردن
                        </button>
                    </div>
                </div>
                <div class="results-content">
                    <div class="result-metadata" id="result-metadata">
                        <!-- Metadata will be displayed here -->
                    </div>
                    <div class="result-text" id="result-text">
                        <!-- Extracted text will be displayed here -->
                    </div>
                </div>
            </section>

            <!-- Instructions Section -->
            <section class="instructions-section">
                <div class="instructions-card">
                    <h3>راهنمای آپلود</h3>
                    <div class="instructions-content">
                        <div class="instruction-item">
                            <i class="fas fa-check-circle"></i>
                            <div>
                                <h4>فایل‌های پشتیبانی شده</h4>
                                <p>PDF، تصاویر (JPG، PNG، BMP، TIFF)، اسناد Word (DOC، DOCX)</p>
                            </div>
                        </div>
                        <div class="instruction-item">
                            <i class="fas fa-info-circle"></i>
                            <div>
                                <h4>حداکثر حجم فایل</h4>
                                <p>50 مگابایت برای هر فایل</p>
                            </div>
                        </div>
                        <div class="instruction-item">
                            <i class="fas fa-clock"></i>
                            <div>
                                <h4>زمان پردازش</h4>
                                <p>1-3 دقیقه بسته به حجم و نوع فایل</p>
                            </div>
                        </div>
                        <div class="instruction-item">
                            <i class="fas fa-shield-alt"></i>
                            <div>
                                <h4>امنیت</h4>
                                <p>فایل‌های شما به صورت امن پردازش و ذخیره می‌شوند</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Notification Panel -->
    <div id="notification-panel" class="notification-panel hidden">
        <div class="notification-header">
            <h3>اعلان‌ها</h3>
            <button class="close-btn" id="close-notification-panel">×</button>
        </div>
        <div class="notification-list" id="notification-list"></div>
        <div class="notification-footer">
            <button class="btn btn-secondary" id="mark-all-read">علامت‌گذاری همه</button>
            <button class="btn btn-danger" id="clear-all-notifications">پاک کردن همه</button>
        </div>
    </div>

    <!-- Mobile Overlay -->
    <div id="mobile-overlay" class="mobile-overlay hidden"></div>

    <!-- JavaScript Modules -->
    <script src="js/core.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/state-manager.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/document-manager.js"></script>
    <script src="js/file-handler.js"></script>
    <script src="js/search-engine.js"></script>
    <script src="js/chart-manager.js"></script>

    <!-- Initialize Upload Page -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing Upload Page...');

            // Initialize all managers
            const managers = {
                core: window.dashboardCore,
                api: window.apiClient,
                state: window.stateManager,
                navigation: window.navigationManager,
                notifications: window.notificationManager,
                documents: window.documentManager,
                files: window.fileHandler,
                search: window.searchEngine,
                charts: window.chartManager
            };

            // Set up cross-component communication
            managers.core.broadcast('upload:initialized', { managers });

            // Initialize upload page functionality
            initializeUploadPage();

            console.log('✅ Upload page initialized successfully');
        });

        function initializeUploadPage() {
            // Set up upload zones
            setupUploadZones();

            // Set up drag and drop
            setupDragAndDrop();

            // Set up event listeners
            setupUploadEventListeners();

            // Set up file validation
            setupFileValidation();
        }

        function setupUploadZones() {
            // PDF upload zone
            const pdfZone = document.getElementById('pdf-upload-zone');
            const pdfBtn = document.getElementById('pdf-upload-btn');
            const pdfInput = document.getElementById('pdf-file-input');

            if (pdfBtn && pdfInput) {
                pdfBtn.addEventListener('click', () => {
                    pdfInput.click();
                });

                pdfInput.addEventListener('change', (e) => {
                    handleFileSelection(e.target.files, 'pdf');
                });
            }

            // Image upload zone
            const imageZone = document.getElementById('image-upload-zone');
            const imageBtn = document.getElementById('image-upload-btn');
            const imageInput = document.getElementById('image-file-input');

            if (imageBtn && imageInput) {
                imageBtn.addEventListener('click', () => {
                    imageInput.click();
                });

                imageInput.addEventListener('change', (e) => {
                    handleFileSelection(e.target.files, 'image');
                });
            }

            // Document upload zone
            const docZone = document.getElementById('document-upload-zone');
            const docBtn = document.getElementById('document-upload-btn');
            const docInput = document.getElementById('document-file-input');

            if (docBtn && docInput) {
                docBtn.addEventListener('click', () => {
                    docInput.click();
                });

                docInput.addEventListener('change', (e) => {
                    handleFileSelection(e.target.files, 'document');
                });
            }
        }

        function setupDragAndDrop() {
            const uploadZones = document.querySelectorAll('.upload-zone');

            uploadZones.forEach(zone => {
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('dragover');
                });

                zone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    if (!zone.contains(e.relatedTarget)) {
                        zone.classList.remove('dragover');
                    }
                });

                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('dragover');
                    
                    const files = Array.from(e.dataTransfer.files);
                    const zoneType = zone.id.includes('pdf') ? 'pdf' : 
                                   zone.id.includes('image') ? 'image' : 'document';
                    
                    handleFileSelection(files, zoneType);
                });
            });
        }

        function handleFileSelection(files, type) {
            if (!files || files.length === 0) return;

            Array.from(files).forEach(file => {
                if (validateFile(file, type)) {
                    addToUploadQueue(file, type);
                } else {
                    showError('فایل نامعتبر', `فایل ${file.name} معتبر نیست یا نوع آن پشتیبانی نمی‌شود.`);
                }
            });
        }

        function validateFile(file, type) {
            const maxSize = 50 * 1024 * 1024; // 50MB
            const allowedTypes = {
                pdf: ['application/pdf'],
                image: ['image/jpeg', 'image/png', 'image/bmp', 'image/tiff'],
                document: ['application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document']
            };

            if (file.size > maxSize) {
                showError('حجم فایل زیاد است', `حجم فایل ${file.name} بیشتر از 50 مگابایت است.`);
                return false;
            }

            if (!allowedTypes[type].includes(file.type)) {
                showError('نوع فایل نامعتبر', `نوع فایل ${file.name} برای این بخش پشتیبانی نمی‌شود.`);
                return false;
            }

            return true;
        }

        function addToUploadQueue(file, type) {
            const queue = document.getElementById('upload-queue');
            const queueItems = document.getElementById('queue-items');
            
            if (queue) queue.style.display = 'block';

            const queueItem = document.createElement('div');
            queueItem.className = 'queue-item';
            queueItem.id = `queue-item-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            
            queueItem.innerHTML = `
                <div class="queue-item-info">
                    <div class="file-icon">
                        <i class="fas ${getFileIcon(type)}"></i>
                    </div>
                    <div class="file-details">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    </div>
                </div>
                <div class="queue-item-actions">
                    <button class="btn-icon remove-btn" onclick="removeFromQueue('${queueItem.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            queueItems.appendChild(queueItem);

            // Start upload
            uploadFile(file, type, queueItem.id);
        }

        function uploadFile(file, type, queueItemId) {
            if (window.fileHandler) {
                window.fileHandler.uploadFile(file, type, (progress) => {
                    updateUploadProgress(progress, queueItemId);
                }).then(result => {
                    showUploadResult(result, queueItemId);
                }).catch(error => {
                    showUploadError(error, queueItemId);
                });
            } else {
                // Fallback upload simulation
                simulateUpload(file, type, queueItemId);
            }
        }

        function simulateUpload(file, type, queueItemId) {
            const progress = document.getElementById('upload-progress');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            if (progress) progress.style.display = 'block';

            let currentProgress = 0;
            const interval = setInterval(() => {
                currentProgress += Math.random() * 10;
                if (currentProgress >= 100) {
                    currentProgress = 100;
                    clearInterval(interval);
                    
                    setTimeout(() => {
                        if (progress) progress.style.display = 'none';
                        showUploadResult({
                            text: `این یک متن نمونه است که به جای پردازش واقعی فایل "${file.name}" نمایش داده می‌شود. در محیط واقعی، متن از فایل شما استخراج خواهد شد.`,
                            metadata: {
                                filename: file.name,
                                size: file.size,
                                type: type,
                                processingTime: Math.random() * 2 + 1,
                                confidence: 0.95
                            }
                        }, queueItemId);
                    }, 500);
                }
                
                if (progressBar) progressBar.style.width = `${currentProgress}%`;
                if (progressText) progressText.textContent = `${Math.round(currentProgress)}%`;
            }, 200);
        }

        function updateUploadProgress(progress, queueItemId) {
            const queueItem = document.getElementById(queueItemId);
            if (queueItem) {
                const progressElement = queueItem.querySelector('.upload-progress');
                if (progressElement) {
                    progressElement.style.width = `${progress}%`;
                }
            }
        }

        function showUploadResult(result, queueItemId) {
            const resultsSection = document.getElementById('results-section');
            const resultMetadata = document.getElementById('result-metadata');
            const resultText = document.getElementById('result-text');

            if (resultsSection) resultsSection.style.display = 'block';
            if (resultMetadata) {
                resultMetadata.innerHTML = `
                    <div class="metadata-item">
                        <span class="metadata-label">نام فایل:</span>
                        <span class="metadata-value">${result.metadata?.filename || 'نامشخص'}</span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">حجم:</span>
                        <span class="metadata-value">${formatFileSize(result.metadata?.size || 0)}</span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">زمان پردازش:</span>
                        <span class="metadata-value">${result.metadata?.processingTime?.toFixed(2) || '0'} ثانیه</span>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">دقت:</span>
                        <span class="metadata-value">${Math.round((result.metadata?.confidence || 0) * 100)}%</span>
                    </div>
                `;
            }
            if (resultText) {
                resultText.textContent = result.text || 'متنی استخراج نشد.';
            }

            // Remove from queue
            removeFromQueue(queueItemId);

            showSuccess('آپلود موفق', 'فایل با موفقیت پردازش شد.');
        }

        function showUploadError(error, queueItemId) {
            removeFromQueue(queueItemId);
            showError('خطا در آپلود', error.message || 'خطا در پردازش فایل');
        }

        function removeFromQueue(queueItemId) {
            const queueItem = document.getElementById(queueItemId);
            if (queueItem) {
                queueItem.remove();
            }

            const queueItems = document.getElementById('queue-items');
            if (queueItems && queueItems.children.length === 0) {
                const queue = document.getElementById('upload-queue');
                if (queue) queue.style.display = 'none';
            }
        }

        function setupUploadEventListeners() {
            // Clear queue button
            const clearQueueBtn = document.getElementById('clear-queue-btn');
            if (clearQueueBtn) {
                clearQueueBtn.addEventListener('click', () => {
                    const queueItems = document.getElementById('queue-items');
                    if (queueItems) queueItems.innerHTML = '';
                    const queue = document.getElementById('upload-queue');
                    if (queue) queue.style.display = 'none';
                });
            }

            // Copy result button
            const copyResultBtn = document.getElementById('copy-result-btn');
            if (copyResultBtn) {
                copyResultBtn.addEventListener('click', () => {
                    const resultText = document.getElementById('result-text');
                    if (resultText && resultText.textContent) {
                        navigator.clipboard.writeText(resultText.textContent).then(() => {
                            showSuccess('کپی شد', 'متن با موفقیت در کلیپ‌بورد کپی شد.');
                        }).catch(() => {
                            showError('خطا در کپی', 'نمی‌توان متن را کپی کرد.');
                        });
                    }
                });
            }

            // Download result button
            const downloadResultBtn = document.getElementById('download-result-btn');
            if (downloadResultBtn) {
                downloadResultBtn.addEventListener('click', () => {
                    const resultText = document.getElementById('result-text');
                    if (resultText && resultText.textContent) {
                        const blob = new Blob([resultText.textContent], { type: 'text/plain' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'extracted_text.txt';
                        a.click();
                        URL.revokeObjectURL(url);
                        showSuccess('دانلود شد', 'فایل با موفقیت دانلود شد.');
                    }
                });
            }

            // Clear result button
            const clearResultBtn = document.getElementById('clear-result-btn');
            if (clearResultBtn) {
                clearResultBtn.addEventListener('click', () => {
                    const resultsSection = document.getElementById('results-section');
                    const resultMetadata = document.getElementById('result-metadata');
                    const resultText = document.getElementById('result-text');
                    
                    if (resultsSection) resultsSection.style.display = 'none';
                    if (resultMetadata) resultMetadata.innerHTML = '';
                    if (resultText) resultText.textContent = '';
                });
            }

            // Mobile menu toggle
            const mobileToggle = document.getElementById('mobile-menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');

            if (mobileToggle && sidebar) {
                mobileToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('open');
                    overlay.classList.toggle('hidden');
                });
            }

            if (overlay) {
                overlay.addEventListener('click', () => {
                    sidebar.classList.remove('open');
                    overlay.classList.add('hidden');
                });
            }

            // Notification panel
            const notificationBell = document.getElementById('notification-bell');
            const notificationPanel = document.getElementById('notification-panel');
            const closePanel = document.getElementById('close-notification-panel');

            if (notificationBell && notificationPanel) {
                notificationBell.addEventListener('click', () => {
                    notificationPanel.classList.toggle('hidden');
                });
            }

            if (closePanel && notificationPanel) {
                closePanel.addEventListener('click', () => {
                    notificationPanel.classList.add('hidden');
                });
            }
        }

        function setupFileValidation() {
            // File validation is handled in handleFileSelection function
        }

        function getFileIcon(type) {
            const icons = {
                pdf: 'fa-file-pdf',
                image: 'fa-file-image',
                document: 'fa-file-word'
            };
            return icons[type] || 'fa-file';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 بایت';
            const k = 1024;
            const sizes = ['بایت', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showSuccess(title, message) {
            if (window.notificationManager) {
                window.notificationManager.showSuccess(title, message);
            } else {
                alert(`${title}: ${message}`);
            }
        }

        function showError(title, message) {
            if (window.notificationManager) {
                window.notificationManager.showError(title, message);
            } else {
                alert(`${title}: ${message}`);
            }
        }

        // Global function for queue removal
        window.removeFromQueue = removeFromQueue;
    </script>
</body>
</html>